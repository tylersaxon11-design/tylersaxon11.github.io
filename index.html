<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>MiniLang Studio — v12.2</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
<style>
/* --- THEME VARIABLES --- */
:root {
  --bg: #0f1112;
  --panel: #151718;
  --border: #2a2d2e;
  --text: #d9e3db;
  --text-muted: #888;
  --accent: #0db24a;
  --danger: #e04f4f;
  --warn: #e0b04f;
  
  --s-pink: #d487ae; --s-yellow: #d1c970; --s-purple: #9e7ccf;
  --s-orange: #d69c58; --s-cyan: #6cb6c4; --s-green: #8fb573;
  --s-blue: #6cb6c4; --s-comment: #6a6e75; --s-num: #8fb573;
}

[data-theme="light"] {
  --bg: #f4f4f4; --panel: #ffffff; --border: #d0d0d0; --text: #222; --text-muted: #666; --accent: #009940;
  --s-pink: #a04070; --s-yellow: #9e7c00; --s-purple: #6f42c1; --s-orange: #b05a00;
  --s-cyan: #007a99; --s-green: #388020; --s-blue: #005cc5; --s-comment: #6a737d; --s-num: #388020;
}

*{box-sizing:border-box}
body{ margin:0; font-family:"Fira Mono", monospace; background:var(--bg); color:var(--text); transition:0.2s; }

/* Header */
.header{ display:flex; align-items:center; gap:16px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--panel); }
.file-btn{ position:relative; }
.file-btn button{ background:transparent; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; }
.file-menu{ position:absolute; left:0; top:46px; background:var(--panel); border:1px solid var(--border); padding:8px; border-radius:8px; display:none; min-width:260px; z-index:50; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
.file-menu .menu-row button, .file-menu .menu-row label{ display:block; width:100%; background:transparent; color:var(--text); border:none; text-align:left; padding:8px; cursor:pointer; border-radius:6px; }
.file-menu .menu-row button:hover{background:rgba(128,128,128,0.1)}
.header select{ background:transparent; color:var(--text); border:1px solid var(--border); padding:8px; border-radius:6px; outline:none; }

/* Resolution Inputs */
.res-inputs { display:flex; align-items:center; gap:5px; font-size:12px; color:var(--text-muted); }
.res-inputs input { width:60px; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:4px; border-radius:4px; text-align:center; }

/* Tabs */
.tabs{display:flex; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border)}
.tab{ padding:10px 16px; border-radius:8px; cursor:pointer; color:var(--text-muted); transition:0.2s; }
.tab:hover{background:rgba(128,128,128,0.1)}
.tab.active{background:var(--panel); border:1px solid var(--border); color:var(--text); font-weight:700}

/* Layout */
.container{display:grid; grid-template-columns:1fr 360px; gap:18px; padding:16px}
@media(max-width:980px){ .container{grid-template-columns:1fr} }

.editor, .sidebar{ background:var(--panel); padding:14px; border-radius:10px; border:1px solid var(--border); }
.editor .topbar{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px;}
.editor .controls{display:flex; gap:12px; align-items:center}
.status-indicator{ width:10px; height:10px; border-radius:50%; background:#777; transition:0.3s; }
.status-indicator.running{ background:var(--accent); box-shadow:0 0 8px var(--accent); }

/* Editor Layering */
.editor-container { position: relative; width: 100%; height: 450px; background: var(--bg); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
textarea#code, pre#highlighting { margin: 0; padding: 12px; border: 0; width: 100%; height: 100%; position: absolute; top: 0; left: 0; font-size: 15px; line-height: 1.5; font-family: "Fira Mono", monospace; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }
textarea#code { color: transparent; background: transparent; caret-color: var(--text); z-index: 1; resize: none; outline: none; }
textarea#code::selection { background: rgba(128,128,128, 0.3); color: transparent; }
pre#highlighting { z-index: 0; color: var(--text); pointer-events: none; }

/* --- GAME STAGE (FIXED RESOLUTION) --- */
.game-stage-wrapper {
  background: #000;
  border-radius: 6px;
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: auto;
  border: 1px solid var(--border);
}

.game-stage {
  width: 640px; /* Default */
  height: 360px; /* Default */
  background: #111;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  border: 1px solid #333;
  flex-shrink: 0;
  font-family: "Fira Mono", monospace;
  transition: width 0.3s, height 0.3s;
}

/* UI Builder Layout */
.ui-builder-layout { display:flex; gap:12px; height:450px; }
.ui-canvas-container { flex:1; background:var(--bg); border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); overflow:auto; padding:20px;}
.ui-toolbar { width:200px; display:flex; flex-direction:column; gap:10px; border-left:1px solid var(--border); padding-left:12px; }

/* Draggable Elements */
.ui-element { position:absolute; cursor:grab; user-select:none; padding:2px 4px; border:1px dashed transparent; white-space:nowrap; z-index:100; }
.ui-element:hover { border-color:var(--text-muted); }
.ui-element.selected { border-color:var(--accent); cursor:grabbing; }

/* Prop Panel */
.prop-group { margin-bottom:8px; }
.prop-group label { display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px; }
.prop-group input { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:6px; border-radius:4px; font-family:"Fira Mono"; font-size:12px; }

/* Color Picker UI */
#colorPicker {
  position: fixed; display: none; background: var(--panel); border: 1px solid var(--border);
  padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100;
  grid-template-columns: repeat(8, 1fr); gap: 6px; width: 260px;
}
.color-swatch { width: 24px; height: 24px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
.color-swatch:hover { transform: scale(1.1); border-color: #fff; z-index:2; box-shadow:0 2px 5px rgba(0,0,0,0.5); }

/* Syntax Colors */
.c-pink { color: var(--s-pink); font-weight:bold; }
.c-yellow { color: var(--s-yellow); }
.c-purple { color: var(--s-purple); }
.c-orange { color: var(--s-orange); }
.c-cyan { color: var(--s-cyan); font-style: italic; }
.c-green { color: var(--s-green); }
.c-blue { color: var(--s-blue); }
.c-comment { color: var(--s-comment); font-style: italic; }
.c-num { color: var(--s-num); }

/* Buttons */
button.insert-btn, button.action { cursor:pointer; background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; font-weight:700; font-family:"Fira Mono", monospace; }
button.insert-btn { width:100%; text-align:left; margin-bottom:8px; background:rgba(128,128,128,0.1); color:var(--text-muted); font-weight:400; transition:0.2s; border:1px solid var(--border); }
button.insert-btn:hover { background:rgba(128,128,128,0.2); border-color:var(--text); color:var(--text); }
button.small-ghost{ background:transparent; color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:8px; cursor:pointer; }
button.danger-btn{ background:transparent; color:var(--danger); border:1px solid var(--danger); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px; }

/* Output & Assets */
.error-msg { color: var(--danger); font-weight:bold; border-left:3px solid var(--danger); padding-left:8px; }
.asset-list{ margin-top:16px; display:flex; flex-direction:column; gap:8px; }
.asset-item{ display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:8px 12px; border-radius:6px; border:1px solid var(--border); }
.asset-name{ font-size:14px; color:var(--text); flex:1; margin-right:10px; word-break:break-all;}
.upload-zone{ border:2px dashed var(--border); padding:20px; text-align:center; border-radius:8px; color:var(--text-muted); cursor:pointer; transition:0.2s; margin-bottom:12px; }
.upload-zone:hover{ border-color:var(--accent); color:var(--accent); }

/* Documentation */
.doc-table { width:100%; border-collapse:collapse; font-size:13px; }
.doc-table td { padding:8px; border-bottom:1px solid var(--border); vertical-align:top; }
.doc-table td:first-child { color: var(--accent); font-weight:bold; width:160px; font-family: "Fira Mono", monospace; }
.doc-table td:last-child { color: var(--text-muted); }
.sep { margin: 20px 0; border-bottom: 1px solid var(--border); }
</style>
</head>
<body>

<!-- Color Picker -->
<div id="colorPicker">
  <div class="color-swatch" style="background:#ffffff" onclick="insertColor('White')"></div>
  <div class="color-swatch" style="background:#000000" onclick="insertColor('Black')"></div>
  <div class="color-swatch" style="background:#ff4f4f" onclick="insertColor('Red')"></div>
  <div class="color-swatch" style="background:#0db24a" onclick="insertColor('Green')"></div>
  <div class="color-swatch" style="background:#4f8fff" onclick="insertColor('Blue')"></div>
  <div class="color-swatch" style="background:#ffff00" onclick="insertColor('Yellow')"></div>
</div>

<div class="header">
  <div class="file-btn">
    <button id="fileToggle">File ▾</button>
    <div class="file-menu" id="fileMenu">
      <div class="menu-row"><button onclick="saveProject()">Save Project (.mini)</button></div>
      <div class="menu-row"><label for="fileInput" style="cursor:pointer">Open Project (.mini)</label></div>
      <div style="height:1px;background:var(--border);margin:6px 0"></div>
      <div class="menu-row"><button onclick="exportToHtml()" style="color:var(--accent); font-weight:bold;">Export as HTML Website</button></div>
      <div style="height:1px;background:var(--border);margin:6px 0"></div>
      <div class="menu-row"><label><input type="checkbox" id="runNewTabToggle"/> Run In New Tab</label></div>
    </div>
  </div>
  <div style="font-weight:700; color:var(--accent)">MiniLang Studio v12.2</div>
  
  <!-- Resolution Changer -->
  <div class="res-inputs" style="margin-left:20px;">
    Res: <input type="number" id="resW" value="640" onchange="updateResolution()"> x <input type="number" id="resH" value="360" onchange="updateResolution()">
  </div>
  
  <div style="flex:1"></div>
  <select id="themeSelect" onchange="changeTheme(this.value)">
    <option value="system">System</option><option value="dark">Dark</option><option value="light">Light</option>
  </select>
</div>

<div class="tabs">
  <div class="tab active" data-tab="editor" onclick="openTab('editor')">Editor</div>
  <div class="tab" data-tab="ui" onclick="openTab('ui')">UI Maker</div>
  <div class="tab" data-tab="sounds" onclick="openTab('sounds')">Sounds</div>
  <div class="tab" data-tab="images" onclick="openTab('images')">Images</div>
  <div class="tab" data-tab="docs" onclick="openTab('docs')">Docs</div>
</div>

<div class="container">
  
  <!-- EDITOR SECTION -->
  <section class="editor" id="editorSection">
    <div class="topbar">
      <div><strong>Code</strong></div>
      <div class="controls">
        <div id="statusIndicator" class="status-indicator"></div>
        <button class="action" id="runBtn" onclick="onRunClicked()">Run</button>
        <button class="small-ghost" onclick="stopExecution()">Stop</button>
        <button class="small-ghost" onclick="clearOutput()">Clear</button>
      </div>
    </div>
    <div class="editor-container">
        <pre id="highlighting" aria-hidden="true"></pre>
        <textarea id="code" spellcheck="false" oninput="updateHighlighting()" onscroll="syncScroll()"></textarea>
    </div>
    <div style="margin-top:12px; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Game Output</div>
    <div class="game-stage-wrapper">
        <div id="output" class="game-stage"></div>
    </div>
  </section>

  <!-- UI MAKER SECTION -->
  <section class="editor" id="uiSection" style="display:none">
    <div class="topbar"><strong>UI Maker</strong></div>
    <div class="ui-builder-layout">
        <!-- Canvas Container Centers the Fixed Stage -->
        <div class="ui-canvas-container">
            <div id="uiCanvas" class="game-stage" ondrop="dropUI(event)" ondragover="allowDrop(event)" onclick="deselectUI(event)">
                <!-- UI Elements -->
            </div>
        </div>
        
        <div class="ui-toolbar">
            <button class="insert-btn" onclick="addUIElement()">+ Add Text</button>
            <div id="propPanel" style="display:none">
                <div style="font-weight:bold; margin-bottom:8px; color:var(--accent)">Properties</div>
                
                <div class="prop-group">
                    <label style="color:var(--accent)">Element Name (ID)</label>
                    <input type="text" id="pName" placeholder="e.g. Text1" oninput="updateUIProp('name', this.value)">
                </div>
                
                <div class="prop-group">
                    <label>Text Content</label>
                    <input type="text" id="pContent" oninput="updateUIProp('content', this.value)">
                </div>
                <div class="prop-group">
                    <label style="color:var(--accent)">Bind Variable (e.g. Score)</label>
                    <input type="text" id="pVar" placeholder="Variable Name" oninput="updateUIProp('varName', this.value)">
                </div>
                <div class="prop-group">
                    <label>Color</label>
                    <input type="text" id="pColor" oninput="updateUIProp('color', this.value)">
                </div>
                <div class="prop-group">
                    <label>Size (px)</label>
                    <input type="number" id="pSize" oninput="updateUIProp('size', this.value)">
                </div>
                <button class="danger-btn" onclick="deleteSelectedUI()" style="width:100%; margin-top:8px">Delete</button>
            </div>
            <div id="noSelMsg" style="margin-top:20px; color:var(--text-muted); font-size:12px; text-align:center">
                Select an element to edit properties.
            </div>
        </div>
    </div>
  </section>

  <!-- OTHER TABS -->
  <section class="editor" id="soundsSection" style="display:none">
    <div class="topbar"><strong>Sounds</strong></div>
    <div style="margin-top:16px;">
      <div class="upload-zone" onclick="document.getElementById('soundInput').click()">Click to Upload<input type="file" id="soundInput" accept=".mp3,.wav,.m4a" multiple style="display:none" onchange="handleAssetUpload(this, 'sound')"/></div>
      <div class="asset-list" id="soundList"></div>
    </div>
  </section>

  <section class="editor" id="imagesSection" style="display:none">
    <div class="topbar"><strong>Images</strong></div>
    <div style="margin-top:16px;">
      <div class="upload-zone" onclick="document.getElementById('imageInput').click()">Click to Upload<input type="file" id="imageInput" accept=".png,.jpg,.jpeg,.gif" multiple style="display:none" onchange="handleAssetUpload(this, 'image')"/></div>
      <div class="asset-list" id="imageList"></div>
    </div>
  </section>

  <section class="editor" id="docsSection" style="display:none; overflow-y:auto; max-height:600px">
    <div class="topbar"><strong>Full Documentation</strong></div>
    <div style="margin-top:16px;">
      <h3>UI Commands</h3>
      <table class="doc-table">
        <tr><td>Name:Text("Str")</td><td>Change UI text content.<br>Ex: <code>Status:Text("HP: 100")</code></td></tr>
        <tr><td>Name:Hide</td><td>Hide UI Element.</td></tr>
        <tr><td>Name:Show</td><td>Show UI Element.</td></tr>
      </table>
      <div class="sep"></div>
      <h3>Text & Display</h3>
      <table class="doc-table">
        <tr><td>Title("Text")</td><td>Sets the Browser Tab Name.</td></tr>
        <tr><td>print("Text")</td><td>Prints normal text to the screen.</td></tr>
        <tr><td>PrintColor("Color")</td><td>Sets text color (Red, #ff0000).</td></tr>
        <tr><td>BackgroundColor("Col")</td><td>Sets the screen background color.</td></tr>
        <tr><td>ClearOutput</td><td>Removes all text (keeps images).</td></tr>
      </table>
      <div class="sep"></div>
      <h3>Visuals</h3>
      <table class="doc-table">
        <tr><td>Name:Draw(x, y)</td><td>Draws image.</td></tr>
        <tr><td>Name:Move(x, y)</td><td>Moves image.</td></tr>
        <tr><td>Name:FullScreen</td><td>Background image.</td></tr>
      </table>
    </div>
  </section>

  <aside class="sidebar">
    <div class="doc-section">
      <h3>Quick Inserts</h3>
      <button class="insert-btn" onclick="insertCode(`Title(&quot;Header&quot;)`)">Title</button>
      <button class="insert-btn" onclick="insertCode(`print(&quot;Hello&quot;)`)">Print</button>
      <button class="insert-btn" onclick="insertCode(`PrintColor(&quot;&quot;)`)">Print Color</button>
      <button class="insert-btn" onclick="insertCode(`UiName:Text(&quot;Hello&quot;)`)">Set UI Text</button>
      <button class="insert-btn" onclick="insertCode(`BackgroundColor(&quot;&quot;)`)">BG Color</button>
      <button class="insert-btn" onclick="insertCode('wait(1)')">Wait</button>
      <button class="insert-btn" onclick="insertCode('ClearOutput')">ClearOutput</button>
      <div style="height:8px"></div>
      <button class="insert-btn" onclick="insertAssetCommand('sound')">Play Sound</button>
      <button class="insert-btn" onclick="insertAssetCommand('image')">Draw Image</button>
      <div style="height:8px"></div>
      <button class="insert-btn" onclick="insertCode('Forever\n    \nend')">Forever Loop</button>
      <button class="insert-btn" onclick="insertCode('if 1=1 then\n    \nelse\n    \nend')">If / Else</button>
    </div>
  </aside>
</div>

<input type="file" id="fileInput" accept=".mini,.lang,.txt" style="display:none" onchange="loadProject(this)"/>

<script>
/* --- 1. Global State --- */
const CURRENT_VERSION = 12.2;
const assets = { sounds: {}, images: {} }; 
const soundObjects = {}; 
let uiElements = []; 
let uiIdCounter = 0;
let selectedUIId = null;
let stopFlag = false;
let GAME_W = 640;
let GAME_H = 360;

/* --- 2. Resolution Management --- */
function updateResolution(){
  GAME_W = parseInt(document.getElementById('resW').value) || 640;
  GAME_H = parseInt(document.getElementById('resH').value) || 360;
  
  const stages = document.querySelectorAll('.game-stage');
  stages.forEach(el => {
    el.style.width = GAME_W + 'px';
    el.style.height = GAME_H + 'px';
  });
}
// Initialize
updateResolution();

/* --- 3. Color Picker & Theme --- */
const colorPicker = document.getElementById('colorPicker');
const textarea = document.getElementById('code');

textarea.addEventListener('click', (e) => {
  const pos = textarea.selectionStart;
  const val = textarea.value;
  const before = val.substring(0, pos);
  if(before.trim().endsWith('PrintColor("') || before.trim().endsWith("PrintColor('") ||
     before.trim().endsWith('BackgroundColor("') || before.trim().endsWith("BackgroundColor('")) {
      colorPicker.style.display = 'grid';
      colorPicker.style.left = e.clientX + 'px';
      colorPicker.style.top = e.clientY + 'px';
  } else { colorPicker.style.display = 'none'; }
});
document.addEventListener('click', (e) => {
  if(e.target !== textarea && !colorPicker.contains(e.target) && !e.target.classList.contains('insert-btn')) colorPicker.style.display = 'none';
});
function insertColor(c) { insertCode(c); colorPicker.style.display = 'none'; }

function changeTheme(val) {
  if(val==='system'){
    document.documentElement.removeAttribute('data-theme');
    if (window.matchMedia('(prefers-color-scheme: light)').matches) document.documentElement.setAttribute('data-theme', 'light');
  } else { document.documentElement.setAttribute('data-theme', val); }
}
changeTheme('system');

const fileMenu = document.getElementById('fileMenu');
document.getElementById('fileToggle').onclick=(e)=>{e.stopPropagation(); fileMenu.style.display=fileMenu.style.display==='block'?'none':'block';};
document.onclick=()=>fileMenu.style.display='none';

function openTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  ['editor','ui','sounds','images','docs'].forEach(n=>document.getElementById(n+'Section').style.display='none');
  document.getElementById(`${name}Section`).style.display='block';
}

/* --- 4. UI MAKER LOGIC --- */
const uiCanvas = document.getElementById('uiCanvas');
const propPanel = document.getElementById('propPanel');
const noSelMsg = document.getElementById('noSelMsg');

function addUIElement(){
    uiIdCounter++;
    const name = "Text" + uiIdCounter;
    // Default position at center-ish
    const el = { id: uiIdCounter, name: name, x: GAME_W/2-30, y: GAME_H/2-10, content: "Text", varName: "", color: "white", size: 16 };
    uiElements.push(el);
    renderUIBuilder();
    selectUI(el.id);
}

function renderUIBuilder(){
    uiCanvas.innerHTML = '';
    uiElements.forEach(el => {
        const d = document.createElement('div');
        d.className = 'ui-element' + (selectedUIId === el.id ? ' selected' : '');
        d.style.left = el.x + 'px'; d.style.top = el.y + 'px';
        d.style.color = el.color; d.style.fontSize = el.size + 'px';
        d.innerText = el.content + (el.varName ? ` [$${el.varName}]` : '');
        d.title = el.name; // Show Name on Hover
        
        d.draggable = true;
        d.ondragstart = (e) => { 
            e.dataTransfer.setData("id", el.id); 
            // Save offset so we drag exactly where clicked
            const rect = d.getBoundingClientRect();
            e.dataTransfer.setData("offsetX", e.clientX - rect.left);
            e.dataTransfer.setData("offsetY", e.clientY - rect.top);
        };
        d.onclick = (e) => { e.stopPropagation(); selectUI(el.id); };
        uiCanvas.appendChild(d);
    });
}

function allowDrop(ev) { ev.preventDefault(); }
function dropUI(ev) {
    ev.preventDefault();
    const id = parseInt(ev.dataTransfer.getData("id"));
    const offX = parseInt(ev.dataTransfer.getData("offsetX")) || 0;
    const offY = parseInt(ev.dataTransfer.getData("offsetY")) || 0;
    
    const rect = uiCanvas.getBoundingClientRect(); 
    const el = uiElements.find(e => e.id === id);
    if(el){
        // Calculate relative position with offset
        el.x = ev.clientX - rect.left - offX;
        el.y = ev.clientY - rect.top - offY;
        renderUIBuilder(); selectUI(id);
    }
}

function selectUI(id){
    selectedUIId = id;
    const el = uiElements.find(e => e.id === id);
    if(el){
        propPanel.style.display='block'; noSelMsg.style.display='none';
        document.getElementById('pName').value = el.name;
        document.getElementById('pContent').value = el.content;
        document.getElementById('pVar').value = el.varName;
        document.getElementById('pColor').value = el.color;
        document.getElementById('pSize').value = el.size;
    } else deselectUI();
    renderUIBuilder();
}

function deselectUI(e){
    if(e && e.target !== uiCanvas) return;
    selectedUIId = null;
    propPanel.style.display='none'; noSelMsg.style.display='block';
    renderUIBuilder();
}

function updateUIProp(key, val){
    const el = uiElements.find(e => e.id === selectedUIId);
    if(el){ el[key] = val; renderUIBuilder(); }
}

function deleteSelectedUI(){
    uiElements = uiElements.filter(e => e.id !== selectedUIId);
    deselectUI();
}

/* --- 5. Assets --- */
function handleAssetUpload(input, type){
  if(!input.files.length) return;
  for(let f of input.files){
    const reader = new FileReader();
    reader.onload = function(e){
      const dataUrl = e.target.result;
      if(type==='sound'){
        assets.sounds[f.name] = dataUrl;
        soundObjects[f.name] = new Audio(dataUrl);
      } else {
        assets.images[f.name] = dataUrl;
      }
      renderAssetList(type);
    };
    reader.readAsDataURL(f);
  }
  input.value='';
}

function renderAssetList(type){
  const list = document.getElementById(type+'List');
  const store = type==='sound' ? assets.sounds : assets.images;
  list.innerHTML = '';
  if(Object.keys(store).length === 0) { list.innerHTML = `<div style="padding:10px;color:var(--text-muted)">No ${type}s.</div>`; return; }

  Object.keys(store).forEach(name => {
    const item = document.createElement('div'); item.className = 'asset-item';
    const span = document.createElement('span'); span.className='asset-name'; span.innerText=name;
    const delBtn = document.createElement('button'); delBtn.className='danger-btn'; delBtn.innerText='✕';
    delBtn.onclick = () => { delete store[name]; if(type==='sound') delete soundObjects[name]; renderAssetList(type); };
    item.append(span, delBtn);
    list.append(item);
  });
}

function insertAssetCommand(type){
  const store = type==='sound' ? assets.sounds : assets.images;
  const keys = Object.keys(store);
  const name = keys.length ? keys[0] : (type==='sound'?"sound.mp3":"image.png");
  if(type==='sound') insertCode(`${name}:Play`);
  else insertCode(`${name}:Draw(10, 10)`);
}

/* --- 6. Editor --- */
const pre = document.getElementById('highlighting');
let savedSel = {s:0,e:0};
function saveSel(){ savedSel={s:textarea.selectionStart,e:textarea.selectionEnd}; }
['keyup','mouseup','input','blur'].forEach(ev=>textarea.addEventListener(ev,saveSel));

function insertCode(str){
  let s=savedSel.s, e=savedSel.e;
  if(document.activeElement===textarea){ s=textarea.selectionStart; e=textarea.selectionEnd; }
  textarea.value = textarea.value.substring(0,s)+str+textarea.value.substring(e);
  textarea.selectionStart=textarea.selectionEnd=s+str.length;
  savedSel={s:s+str.length,e:s+str.length};
  textarea.focus(); updateHighlighting();
}

function updateHighlighting() {
  let t = textarea.value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  t = t.replace(/\(([^)\n]*)\)/g, '(<span class="c-purple">$1</span>)');
  t = t.replace(/(:Play|:StopPlay|:Draw|:Move|:FullScreen|:Hide|:Show|:Text)\b/g, '<span class="c-pink">$1</span>');
  t = t.replace(/\b(print|Title|PrintSize|PrintColor|BackgroundColor)\b/g, '<span class="c-yellow">$1</span>');
  t = t.replace(/\b(input)\b/g, '<span class="c-cyan">$1</span>');
  t = t.replace(/\b(ClearOutput|ClearImages)\b/g, '<span class="c-green">$1</span>');
  t = t.replace(/\b(Forever|if|then|end|Change|By|wait|Pressed|elseif|else)\b/g, '<span class="c-blue">$1</span>');
  t = t.replace(/\b([A-Z]\w*)\b/g, m => ["Forever","Change","By","ClearOutput","ClearImages","Pressed"].includes(m) ? m : '<span class="c-orange">'+m+'</span>');
  t = t.replace(/\b(\d+)\b/g, '<span class="c-num">$1</span>');
  t = t.replace(/(#|--)(.*?)(\n|$)/g, '<span class="c-comment">$1$2</span>$3');
  pre.innerHTML = t + '<br>';
}
function syncScroll() { pre.scrollTop=textarea.scrollTop; pre.scrollLeft=textarea.scrollLeft; }
textarea.addEventListener('keydown', function(e){
  if(e.key==='Tab'){ e.preventDefault(); document.execCommand('insertText', false, "    "); }
  if(e.key === 'Enter'){
    e.preventDefault();
    const pos = textarea.selectionStart;
    const val = textarea.value;
    const lastN = val.lastIndexOf('\n', pos - 1);
    const line = val.substring(lastN + 1, pos);
    let indent = (line.match(/^\s*/) || [""])[0];
    if(line.trim().endsWith('then') || line.trim().startsWith('Forever') || line.trim().startsWith('else')) indent += "    ";
    document.execCommand('insertText', false, "\n" + indent);
  }
});
updateHighlighting();

/* --- 7. Project I/O --- */
function saveProject(){
  const project = { version: CURRENT_VERSION, code: textarea.value, assets: assets, ui: uiElements, w: GAME_W, h: GAME_H };
  const blob = new Blob([JSON.stringify(project)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'project.mini'; a.click();
}
function loadProject(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => { 
    try {
      const proj = JSON.parse(e.target.result);
      textarea.value = proj.code || "";
      assets.sounds = proj.assets?.sounds || {};
      assets.images = proj.assets?.images || {};
      uiElements = proj.ui || [];
      if(proj.w){
          document.getElementById('resW').value = proj.w;
          document.getElementById('resH').value = proj.h;
          updateResolution();
      }
      renderAssetList('sound'); renderAssetList('image'); renderUIBuilder();
      updateHighlighting();
    } catch(err) { alert("Failed to load file."); }
  };
  reader.readAsText(file);
}

/* --- 8. Interpreter --- */
const keysDown = {};
document.addEventListener('keydown', e=> keysDown[e.key.toUpperCase()] = true);
document.addEventListener('keyup', e=> keysDown[e.key.toUpperCase()] = false);

function clearOutput(){ document.getElementById('output').innerHTML = ''; document.getElementById('output').style.background = '#111'; }
function stopExecution(){ 
  stopFlag = true;
  document.getElementById('statusIndicator').classList.remove('running');
  Object.values(soundObjects).forEach(s => { s.pause(); s.currentTime=0; });
}
function printError(msg){
  const div = document.createElement('div'); div.className = 'error-msg'; div.innerText = "Error: " + msg;
  document.getElementById('output').appendChild(div); stopExecution();
}
function safeEval(expr){ try{ return Function('"use strict";return ('+expr+')')(); } catch(e){ return null; } }

function evalExpr(expr, vars){
  const tokens = expr.split(/(".*?"|'.*?')/g);
  for(let i=0; i<tokens.length; i++){
    if(tokens[i].startsWith('"') || tokens[i].startsWith("'")) continue;
    tokens[i] = tokens[i].replace(/([^=<>!])=([^=])/g, '$1==$2');
    tokens[i] = tokens[i].replace(/\b[a-zA-Z_]\w*\b/g, m => {
      if(vars.hasOwnProperty(m)) {
         let val = vars[m];
         return typeof val === 'number' ? val : JSON.stringify(val);
      }
      return (m==='input'?'input':'0');
    });
  }
  const res = safeEval(tokens.join(''));
  if(res === null) throw new Error("Invalid: " + expr);
  return res;
}

function getImgId(name) { return 'img-' + name.replace(/[^a-zA-Z0-9]/g, ''); }

async function run(){
  stopFlag = false;
  clearOutput();
  document.getElementById('statusIndicator').classList.add('running');
  const code = textarea.value;
  const lines = code.split('\n');
  const vars = {};
  const outputEl = document.getElementById('output');
  let currentFontSize = 16;
  let currentColor = ''; 
  
  // Render Initial UI in Output
  const runtimeUIRefs = [];
  uiElements.forEach(el => {
      const d = document.createElement('div');
      d.style.position = 'absolute';
      d.style.left = el.x + 'px'; d.style.top = el.y + 'px';
      d.style.color = el.color; d.style.fontSize = el.size + 'px';
      d.innerText = el.content;
      d.style.zIndex = 10;
      outputEl.appendChild(d);
      runtimeUIRefs.push({ dom: d, data: el });
  });

  function updateRuntimeUI(){
      runtimeUIRefs.forEach(ref => {
          if(ref.data.varName && vars[ref.data.varName] !== undefined){
              ref.dom.innerText = ref.data.content + " " + vars[ref.data.varName];
          }
      });
  }

  // Handle Command like Name:Text("Hello")
  function handleUICommand(line){
      const match = line.match(/^([a-zA-Z0-9_]+):Text\((.*)\)/);
      if(match){
          const uiName = match[1];
          const contentExpr = match[2];
          
          let finalContent = "";
          const parts = contentExpr.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          parts.forEach(p=>{
             p=p.trim();
             if(p.startsWith('"')||p.startsWith("'")) finalContent += p.slice(1,-1);
             else if(vars.hasOwnProperty(p)) finalContent += vars[p]; 
             else finalContent += p;
          });

          const ref = runtimeUIRefs.find(r => r.data.name === uiName);
          if(ref){
             ref.dom.innerText = finalContent;
             ref.data.content = finalContent; 
          }
          return true;
      }
      return false;
  }

  function manageImage(action, nameOrVar, x, y){
    let realName = nameOrVar;
    if(!assets.images[realName] && vars[nameOrVar] && assets.images[vars[nameOrVar]]) {
        realName = vars[nameOrVar];
    }
    
    const id = getImgId(nameOrVar); 
    let img = document.getElementById(id);

    if(action === 'Draw'){
        if(!assets.images[realName]) return;
        if(!img){
            img = document.createElement('img'); img.id = id;
            img.src = assets.images[realName]; img.style.position = 'absolute';
            img.className = 'runtime-image';
            outputEl.appendChild(img);
        } else {
            if(img.src !== assets.images[realName]) img.src = assets.images[realName];
        }
        img.style.left = x + 'px'; img.style.top = y + 'px';
        img.style.width = 'auto'; img.style.height = 'auto'; img.style.display = 'block';
    }
    else if(action === 'Move'){ if(img){ img.style.left = x + 'px'; img.style.top = y + 'px'; } }
    else if(action === 'FullScreen'){ if(img){ img.style.left='0'; img.style.top='0'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; } }
    else if(action === 'Hide'){ if(img) img.style.display = 'none'; }
    else if(action === 'Show'){ if(img) img.style.display = 'block'; }
  }

  function doPrint(line){
    const m = line.match(/\((.*)\)/); if(!m) return;
    const content = m[1];
    const parts = content.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    let finalStr = "";
    parts.forEach(p=>{
      p=p.trim();
      if(p.startsWith('"')||p.startsWith("'")) finalStr += p.slice(1,-1);
      else if(vars.hasOwnProperty(p)) finalStr += vars[p]; 
      else finalStr += p;
      finalStr += " ";
    });
    const el = document.createElement('div');
    if(finalStr.trim() === "") el.innerHTML = "&nbsp;";
    else el.innerText = finalStr.trim();
    el.style.fontSize = currentFontSize + 'px';
    if(currentColor) el.style.color = currentColor;
    outputEl.appendChild(el);
    outputEl.scrollTop = outputEl.scrollHeight;
  }

  async function runBlock(blockLines){
    for(let i=0; i<blockLines.length && !stopFlag; i++){
      let line = blockLines[i].trim();
      updateRuntimeUI(); 
      
      if(!line || line.startsWith('--') || line.startsWith('#')) continue;

      try {
        if(handleUICommand(line)) continue;

        if(line.startsWith('PrintSize(')){
            const size = parseFloat(line.match(/\((.*)\)/)[1]);
            if(!isNaN(size)) currentFontSize = size;
            continue;
        }
        if(line.startsWith('PrintColor(')){
            const raw = line.match(/\((.*)\)/)[1];
            currentColor = raw.replace(/['"]/g, '');
            continue;
        }
        if(line.startsWith('BackgroundColor(')){
            const raw = line.match(/\((.*)\)/)[1];
            outputEl.style.background = raw.replace(/['"]/g, '');
            continue;
        }
        
        if(/:Draw\(/.test(line)){
            const name = line.split(':Draw')[0].trim(); const args = line.match(/:Draw\((.*)\)/)[1];
            const [x,y] = args.split(',').map(n => parseFloat(n));
            manageImage('Draw', name, x, y); continue;
        }
        if(/:Move\(/.test(line)){
            const name = line.split(':Move')[0].trim(); const args = line.match(/:Move\((.*)\)/)[1];
            const [x,y] = args.split(',').map(n => parseFloat(n));
            manageImage('Move', name, x, y); continue;
        }
        if(/:FullScreen$/.test(line)){ manageImage('FullScreen', line.replace(/:FullScreen$/,'').trim()); continue; }
        if(/:Hide$/.test(line)){ manageImage('Hide', line.replace(/:Hide$/,'').trim()); continue; }
        if(/:Show$/.test(line)){ manageImage('Show', line.replace(/:Show$/,'').trim()); continue; }
        if(line === 'ClearImages'){ document.querySelectorAll('.runtime-image').forEach(e=>e.remove()); continue; }
        
        if(/:Play$/.test(line)){
          const fname = line.replace(/:Play$/,'');
          if(soundObjects[fname]){ soundObjects[fname].currentTime=0; soundObjects[fname].play(); } continue;
        }
        if(/:StopPlay$/.test(line)){
          const fname = line.replace(/:StopPlay$/,'');
          if(soundObjects[fname]) soundObjects[fname].pause(); continue;
        }

        if(line.startsWith('wait(')){
          const sec = parseFloat(line.match(/\((.*)\)/)[1]) || 0;
          await new Promise(r=>setTimeout(r, sec*1000)); continue;
        }
        if(line.startsWith('Title')) { 
           const m = line.match(/\((.*)\)/); 
           if(m) document.title = m[1].replace(/['"]/g,''); 
           continue; 
        }
        if(line.startsWith('print')) { doPrint(line); continue; }
        if(line === 'ClearOutput') { Array.from(outputEl.children).forEach(c => { if(!c.classList.contains('runtime-image') && !c.classList.contains('runtime-ui')) c.remove(); }); continue; }
        
        if(line.startsWith("Change ")){
          const parts = line.substring(7).split(" By ");
          if(parts.length < 2) throw new Error("Invalid Change");
          const v = parts[0].trim(); let amount = parseFloat(parts[1].trim());
          if(isNaN(amount)){
              if(vars[parts[1].trim()] !== undefined) amount = Number(vars[parts[1].trim()]);
              else throw new Error("Missing var: " + parts[1]);
          }
          vars[v] = (vars[v]||0) + amount; continue;
        }

        if(line.startsWith('Forever')){
          const sub = []; i++; let d = 1;
          while(i < blockLines.length){
            const l = blockLines[i];
            if(l.trim().startsWith('Forever') || l.trim().startsWith('if')) d++;
            if(l.trim() === 'end') d--;
            if(d === 0) break;
            sub.push(l); i++;
          }
          while(!stopFlag){ await runBlock(sub); await new Promise(r=>setTimeout(r, 10)); }
          continue;
        }

        if(line.startsWith('if ')){
          const branches = [];
          let currentCond = line.substring(3, line.lastIndexOf('then')).trim();
          let currentBlock = [];
          i++; let d = 1;
          while(i < blockLines.length){
            const l = blockLines[i]; const trim = l.trim();
            if(trim.startsWith('if ') || trim.startsWith('Forever')) d++;
            if(trim === 'end') d--;
            if(d === 1 && trim.startsWith('elseif ')){ branches.push({cond: currentCond, block: currentBlock}); currentCond = trim.substring(7, trim.lastIndexOf('then')).trim(); currentBlock = []; i++; continue; }
            if(d === 1 && trim === 'else'){ branches.push({cond: currentCond, block: currentBlock}); currentCond = "true"; currentBlock = []; i++; continue; }
            if(d === 0){ branches.push({cond: currentCond, block: currentBlock}); break; }
            currentBlock.push(l); i++;
          }
          for(const br of branches){
             let met = false;
             if(br.cond === 'true') met = true;
             else if(br.cond.includes('Pressed')){
                 const k = br.cond.replace('Pressed','').trim().toUpperCase();
                 if(keysDown[k]) met = true;
             } else { met = evalExpr(br.cond, vars); }
             if(met){
                 await runBlock(br.block);
                 if(br.cond.includes('Pressed')){ const k = br.cond.replace('Pressed','').trim().toUpperCase(); while(keysDown[k] && !stopFlag) await new Promise(r=>setTimeout(r,20)); }
                 break; 
             }
          }
          continue;
        }

        if(line.includes('=') && !line.startsWith('if')){
          const [lhs, rhs] = line.split('=').map(s=>s.trim());
          if(rhs.toLowerCase().startsWith('input')) {
              await new Promise(r=>setTimeout(r, 50)); 
              vars[lhs] = prompt("Input:");
          }
          else vars[lhs] = evalExpr(rhs, vars);
        }
      } catch(err) { printError(err.message); return; }
    }
  }
  try { await runBlock(lines); while(!stopFlag){ await new Promise(r=>setTimeout(r, 100)); updateRuntimeUI(); } } 
  catch(e) { printError("Runtime: " + e.message); }
}

/* --- 9. Export Logic (Updated to use Fixed Stage & UI Commands) --- */
const runNewTabToggle = document.getElementById('runNewTabToggle');
async function onRunClicked(){
  if(runNewTabToggle.checked){ openRunner(textarea.value, assets, uiElements); } else { run(); }
}

function getRuntimeScript(codeStr, assetsObj, uiObj){
    return `
    const code = ${JSON.stringify(codeStr)}; 
    const assets = ${JSON.stringify(assetsObj)};
    const uiElements = ${JSON.stringify(uiObj)};
    const GAME_W = ${GAME_W}; const GAME_H = ${GAME_H};
    const vars = {}; const keysDown = {}; let stopFlag = false; 
    const log = document.getElementById('output');
    let currentFontSize = 16; let currentColor = '';
    const sounds = {}; for(let k in assets.sounds) sounds[k] = new Audio(assets.sounds[k]);
    
    document.addEventListener('keydown', e=>keysDown[e.key.toUpperCase()]=true);
    document.addEventListener('keyup', e=>keysDown[e.key.toUpperCase()]=false);
    
    // RENDER INITIAL UI
    const uiRefs = [];
    uiElements.forEach(el => {
        const d = document.createElement('div');
        d.style.position = 'absolute'; d.style.left = el.x + 'px'; d.style.top = el.y + 'px';
        d.style.color = el.color; d.style.fontSize = el.size + 'px';
        d.innerText = el.content; d.style.zIndex = 10;
        log.appendChild(d);
        uiRefs.push({dom:d, data:el});
    });

    function updateUI(){
        uiRefs.forEach(ref => {
            if(ref.data.varName && vars[ref.data.varName]!==undefined) 
                ref.dom.innerText = ref.data.content + " " + vars[ref.data.varName];
        });
    }

    function handleUICommand(line){
        const match = line.match(/^([a-zA-Z0-9_]+):Text\\((.*)\\)/);
        if(match){
            let finalContent = "";
            let parts = match[2].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            parts.forEach(p=>{
                p=p.trim();
                if(p.startsWith('"')||p.startsWith("'")) finalContent += p.slice(1,-1);
                else if(vars[p]!==undefined) finalContent += vars[p]; 
                else finalContent += p;
            });
            const ref = uiRefs.find(r => r.data.name === match[1]);
            if(ref){ ref.dom.innerText = finalContent; ref.data.content = finalContent; }
            return true;
        }
        return false;
    }

    function evalExpr(expr, v){
       let tokens = expr.split(/(".*?"|'.*?')/g);
       for(let i=0; i<tokens.length; i++){
         if(tokens[i].startsWith('"')) continue;
         tokens[i] = tokens[i].replace(/([^=<>!])=([^=])/g, '$1==$2');
         tokens[i] = tokens[i].replace(/[a-zA-Z_]\\w*/g, m => {
           if(v[m] !== undefined) return typeof v[m] === 'number' ? v[m] : JSON.stringify(v[m]);
           return (m==='input'?'input':'0');
         });
       }
       try{ return Function('"use strict";return ('+tokens.join('')+')')(); } catch{return 0}
    }

    function getImgId(n){ return 'rt-'+n.replace(/[^a-zA-Z0-9]/g, ''); }
    function manageImage(act, n, x, y){
        let realName = n;
        if(!assets.images[realName] && vars[n] && assets.images[vars[n]]) realName = vars[n];
        
        const id = getImgId(n); let img = document.getElementById(id);
        if(act === 'Draw'){
            if(!assets.images[realName]) return;
            if(!img){ img=document.createElement('img'); img.id=id; img.src=assets.images[realName]; img.style.position='absolute'; log.appendChild(img); }
            else if(img.src !== assets.images[realName]) img.src = assets.images[realName];
            
            img.style.left=x+'px'; img.style.top=y+'px'; img.style.width='auto'; img.style.height='auto'; img.style.display='block';
        }
        else if(act === 'Move'){ if(img){ img.style.left=x+'px'; img.style.top=y+'px'; } }
        else if(act === 'FullScreen'){ if(img){ img.style.left='0'; img.style.top='0'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; } }
        else if(act === 'Hide'){ if(img) img.style.display='none'; }
        else if(act === 'Show'){ if(img) img.style.display='block'; }
    }

    async function runBlock(lines){
      for(let i=0; i<lines.length; i++){
        let line = lines[i].trim();
        updateUI();
        if(!line || line.startsWith('--') || line.startsWith('#')) continue;
        
        if(handleUICommand(line)) continue;

        if(line.startsWith('PrintSize(')){
            const size = parseFloat(line.match(/\\((.*)\\)/)[1]);
            if(!isNaN(size)) currentFontSize = size; continue;
        }
        if(line.startsWith('PrintColor(')){
            const raw = line.match(/\\((.*)\\)/)[1];
            currentColor = raw.replace(/['"]/g, ''); continue;
        }
        if(line.startsWith('BackgroundColor(')){
            const raw = line.match(/\\((.*)\\)/)[1];
            log.style.background = raw.replace(/['"]/g, ''); continue;
        }
        if(/:Draw\\(/.test(line)){
            let n = line.split(':Draw')[0].trim(); let a = line.match(/:Draw\\((.*)\\)/)[1];
            let [x,y] = a.split(',').map(n=>parseFloat(n)); manageImage('Draw', n, x, y); continue;
        }
        if(/:Move\\(/.test(line)){
            let n = line.split(':Move')[0].trim(); let a = line.match(/:Move\\((.*)\\)/)[1];
            let [x,y] = a.split(',').map(n=>parseFloat(n)); manageImage('Move', n, x, y); continue;
        }
        if(/:FullScreen$/.test(line)){ manageImage('FullScreen', line.replace(/:FullScreen$/,'').trim()); continue; }
        if(/:Hide$/.test(line)){ manageImage('Hide', line.replace(/:Hide$/,'').trim()); continue; }
        if(/:Show$/.test(line)){ manageImage('Show', line.replace(/:Show$/,'').trim()); continue; }
        if(line === 'ClearImages'){ log.querySelectorAll('img').forEach(e=>e.remove()); continue; }
        if(/:Play$/.test(line)){ let f = line.replace(/:Play$/,''); if(sounds[f]){ sounds[f].currentTime=0; sounds[f].play(); } continue; }
        if(/:StopPlay$/.test(line)){ let f = line.replace(/:StopPlay$/,''); if(sounds[f]) sounds[f].pause(); continue; }
        
        if(line === 'ClearOutput'){ 
            Array.from(log.children).forEach(c => { if(!c.classList.contains('runtime-image')) c.remove(); }); 
            continue; 
        }
        if(line.startsWith('Change ')){
             let parts = line.substring(7).split(" By "); let v = parts[0].trim(); let am = parseFloat(parts[1]);
             if(isNaN(am)){ if(vars[parts[1].trim()]!==undefined) am = Number(vars[parts[1].trim()]); else am = 0; }
             vars[v] = (vars[v]||0)+am; continue;
        }
        if(line.startsWith('wait(')){ let t = parseFloat(line.match(/\\((.*)\\)/)[1]); await new Promise(r=>setTimeout(r, t*1000)); continue; }
        
        if(line.startsWith('Title')){
           let m = line.match(/\\((.*)\\)/);
           if(m) document.title = m[1].replace(/['"]/g,''); continue;
        }

        if(line.startsWith('print')){
           let m = line.match(/\\((.*)\\)/);
           if(m){
             let parts = m[1].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
             let str = "";
             parts.forEach(p=>{
                p=p.trim();
                if(p.startsWith('"')) str+=p.slice(1,-1); else if(vars[p]!==undefined) str+=vars[p]+" "; else str+=p+" ";
             });
             let el = document.createElement('div');
             if(str.trim()==="") el.innerHTML = "&nbsp;";
             else el.innerText = str.trim();
             el.style.fontSize = currentFontSize + 'px';
             if(currentColor) el.style.color = currentColor;
             log.appendChild(el);
           } continue;
        }
        if(line.startsWith('Forever')){
          let sub = []; i++; let d=1;
          while(i<lines.length){
            let l=lines[i];
            if(l.trim().startsWith('Forever')||l.trim().startsWith('if')) d++;
            if(l.trim()==='end') d--; if(d===0) break; sub.push(l); i++;
          }
          while(!stopFlag){ await runBlock(sub); await new Promise(r=>setTimeout(r,10)); updateUI(); } continue;
        }
        if(line.startsWith('if ')){
          let branches = []; let curCond = line.slice(3, line.lastIndexOf('then')).trim(); let curBlk = [];
          i++; let d=1;
          while(i<lines.length){
            let l=lines[i]; let tr=l.trim();
            if(tr.startsWith('if')||tr.startsWith('Forever')) d++; if(tr==='end') d--;
            if(d===1 && tr.startsWith('elseif ')){ branches.push({c:curCond,b:curBlk}); curCond=tr.slice(7,tr.lastIndexOf('then')).trim(); curBlk=[]; i++; continue; }
            if(d===1 && tr==='else'){ branches.push({c:curCond,b:curBlk}); curCond="true"; curBlk=[]; i++; continue; }
            if(d===0){ branches.push({c:curCond,b:curBlk}); break; }
            curBlk.push(l); i++;
          }
          for(let br of branches){
             let met = false;
             if(br.c === 'true') met = true;
             else if(br.c.includes('Pressed')){ let k = br.c.replace('Pressed','').trim().toUpperCase(); if(keysDown[k]) met=true; }
             else { met = evalExpr(br.c, vars); }
             if(met){
                 await runBlock(br.b);
                 if(br.c.includes('Pressed')){ let k=br.c.replace('Pressed','').trim().toUpperCase(); while(keysDown[k]) await new Promise(r=>setTimeout(r,20)); }
                 break;
             }
          }
          continue;
        }
        if(line.includes('=') && !line.startsWith('if')){
           let [L, R] = line.split('=').map(s=>s.trim());
           if(R.toLowerCase().startsWith('input')) {
               await new Promise(r=>setTimeout(r,50));
               vars[L]=prompt("Input:");
           } else vars[L] = evalExpr(R, vars);
        }
      }
    }
    runBlock(code.split('\\n'));
    `;
}

function openRunner(code, assetsObj, uiObj){
  const win = window.open();
  const scriptContent = getRuntimeScript(code, assetsObj, uiObj);
  win.document.write(`<html><head><title>MiniGame</title><style>body{background:#000;color:#eee;font-family:monospace;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}#output{width:${GAME_W}px;height:${GAME_H}px;background:#111;position:relative;overflow:hidden;border:1px solid #333;box-shadow:0 0 30px #000;}</style></head><body><div id="output"></div><script>${scriptContent}<\/script></body></html>`);
}

function exportToHtml(){
  const code = textarea.value;
  const scriptContent = getRuntimeScript(code, assets, uiElements);
  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>My MiniGame</title>
<style>
  body{background:#000;color:#eee;font-family:monospace;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
  #output{width:${GAME_W}px;height:${GAME_H}px;background:#111;position:relative;overflow:hidden;border:1px solid #333;box-shadow:0 0 30px #000;}
  img{z-index:1;}
</style>
</head>
<body>
  <div id="output"></div>
  <script>${scriptContent}<\/script>
</body>
</html>`;
  
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'game.html'; a.click();
}
</script>
</body>
</html>
